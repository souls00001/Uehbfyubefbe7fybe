-- Services 
local VirtualInputManager = game:GetService("VirtualInputManager")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

-- Ensure RemoteEvent exists for server teleport
if not ReplicatedStorage:FindFirstChild("TeleportEvent") then
    local teleportEvent = Instance.new("RemoteEvent")
    teleportEvent.Name = "TeleportEvent"
    teleportEvent.Parent = ReplicatedStorage
end

local player = game.Players.LocalPlayer
local movementSpeed = 20 -- Speed in studs per second
local isActive = false -- Track if the script is active or not

local locations = {
    {position = Vector3.new(-479, 4, -436), item = "Potato", waitTime = 2},  -- First location (wait 2s)
    {position = Vector3.new(-463, 4, -448), item = "Potato", waitTime = 5},  -- Second location (wait 5s)
    {position = Vector3.new(-463, 4, -474), item = nil, waitTime = 5},        -- Third location (wait 5s)
    {position = Vector3.new(-487, 4, -535), item = "Flour", waitTime = 5},   -- Fourth location (wait 5s)
    {position = Vector3.new(-520, 4, -474), item = nil, waitTime = 62}, -- Fifth location (wait 62s)
    {position = Vector3.new(-32, 4, -25), item = "Potato Chips"} -- Sixth location
}

-- Function to press "E" once
local function pressEOnce()
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
    wait(0.5)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
end

-- Function to equip an item from the player's inventory
local function equipItem(itemName)
    local backpack = player.Backpack
    for _, item in ipairs(backpack:GetChildren()) do
        if item.Name == itemName and item:IsA("Tool") then
            player.Character.Humanoid:EquipTool(item)
            print(itemName .. " equipped!")
            return
        end
    end
    print("No " .. itemName .. " found in the inventory.")
end

-- Function to move the character gradually to target positions
local function moveToTarget(index)
    if not isActive then return end  -- Stop if not active
    if index > #locations then index = 1 end  -- Restart from the first location if all are completed

    local location = locations[index]
    local targetPosition = location.position
    local humanoidRootPart = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end
    
    local startPosition = humanoidRootPart.Position
    local distance = (targetPosition - startPosition).magnitude
    local duration = distance / movementSpeed
    local startTime = tick()

    local moveConnection
    moveConnection = RunService.Heartbeat:Connect(function()
        local elapsedTime = tick() - startTime
        if elapsedTime < duration then
            local newPosition = startPosition:Lerp(targetPosition, elapsedTime / duration)
            humanoidRootPart.CFrame = CFrame.new(newPosition)
        else
            humanoidRootPart.CFrame = CFrame.new(targetPosition)
            moveConnection:Disconnect()
            
            -- Equip item if necessary
            if location.item then
                equipItem(location.item)
            end
            
            -- Press E when arriving at the first location
            if index == 1 then
                pressEOnce()  -- Press E immediately when arriving at the first location
            end
            
            -- Press E at the start of the fourth location
            if index == 4 then
                pressEOnce()  -- Press E immediately when arriving at the fourth location
            end
            
            -- Press E at the start of the fifth location (not the fourth)
            if index == 5 then
                pressEOnce()  -- Press E immediately when arriving at the fifth location
                wait(62)      -- Wait for 62 seconds at the fifth location
            else
                -- Press E for all other locations
                pressEOnce()
            end
            
            -- Wait 5 seconds at the fourth location
            if index == 4 then
                wait(5)
            end
            
            -- Wait if needed for other locations
            if location.waitTime then
                wait(location.waitTime)
            end
            
            -- Move to next location
            moveToTarget(index + 1)
        end
    end)
end

-- Function to toggle the activity on Z press
local function toggleSequence(input)
    if input.KeyCode == Enum.KeyCode.Z then
        isActive = not isActive  -- Toggle the isActive flag
        if isActive then
            print("Starting movement sequence.")
            moveToTarget(1)  -- Start from the first location
        else
            print("Stopping movement sequence.")
        end
    end
end

-- Connect the toggle to the key press
game:GetService("UserInputService").InputBegan:Connect(toggleSequence)

-- Function to remove HoldDuration from all ProximityPrompts
local function modifyProximityPrompts()
    while true do
        for _, instance in ipairs(game:GetService("Workspace"):GetDescendants()) do
            if instance:IsA("ProximityPrompt") then
                instance.HoldDuration = 0
            end
        end
        wait(20)
    end
end

task.spawn(modifyProximityPrompts)
